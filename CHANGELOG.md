## 24-01-24

### упростить архитектуру
- [ ] нарисовать диаграмму (as is, to be)
- [ ] изолировать контексты терминала и ексченжа

- [x] - fix random walk strategy

## 22-01-24

- [x] история цены, свечки - хранение и стрим маркет данных
- [ ] performance reports

## 21-01-24

- [x] runing total Pnl по позиции - еквити, хранение истории

## 19-01-24
- [x] Implement Position Calculation by trade events on client side
- [x] Save Position History on client side - (Equity by time)

## 18-01-24
- [x] Bug: в трейдах есть евенты с Size = 0
- [x] Bug: в ордерах есть евенты с Size = 0

- [x] Fix PnL value in profile
- [-] Reject event when trying to close position

## 17-01-24
- [x] PnL по позициям после отработки стратегии

## 15-01-24

- [ ] история цены, история сделок, эквити
- [x] закрытие позиций по рынку по завершению стратегии
- [x] поификсить багу

## 10-01-24

### [x] Random Walk Strategy 
- прокидывать в стратегию текущую рыночную цену и от нее шагать
- для рыночной цены нужен провайдер
- прокидывать параметр необходимости закрытия позиций по завершению стратегии
- закрывать позции отдельной командой? Какая стратегия закрытия - маркет ордер или лимитный?
- как обеспечить ликвидность при закрытии позиций?

### [x] MarketData Provider
Сводная информация по рынку. По каждому символу:
- текущая цена
- дельта цены с начала торговли в процентах и сумме
- количество и объем трейдов
- информация по стакану (?)

### Performance Report
- еквити акаунта по временной шкале с привязкой к трейдам
- производные: кол-во и объем трейдов (профитных, убыточных)
- просадка
- отношение профита к общему росту цены (коэф. шарпа)
- другие значения - посмотреть в книгах

### CLI интерфейс для запуска и анализа стратегий
- продумать команды и формат входных данных
- [cocona](https://github.com/mayuki/Cocona)


## 03-01-24
### Реализовать тестовый сценарий торговли
- инициализировать систему несколькими учетками
- запустить стратегию и дождаться ее окончания (либо остановить)
- посмотреть открытые позиции и закрыть их (опционально)
- сверить балансы - акаунт + PnL по позцициям + открытые позиции
- балансы по учеткам должны сходиться в ноль

- домен - Profile
- - переименовать RealizedPnl в PnL
  - убрать неиспользуемый метод GetUnrealizedPnL


## 02-01-24

### Учет денег на акааунте
Сейчас движения в позиции никак не влияют на сумму акаунта. Т.е. она вообще никак не участвует в движениях.

Необходимо доработать функционал акаунтинга:
- перед выставлением ордера проверять доступность средств. При необходимости - резервировать средства
- при срабатывании ордера и при движении позиции - отражать соответствующие суммы на акаунте
Сейчас закомментирован код, который вызывал движение в акаунте - но только при закрытии позиции. 
Необходимо расширить функционал работы с аккаунтом для всех типов движений в позиции - не только для закрытия.

#### 03-01-24
- нужна отдельная процедура клиринга или EOD - когда PnL с позциций фиксируется на счетах
- простой вариант - считать Fair Value на лету - сумма на аккаунте плюс PnL по всем позициям в валюте акаунта

### [x] Fix error

## 09-12-23
- [x] пофиксить зависания в трейдинге - race conditions
- [x] доработать ресет для терминала - сброс репозиториев
- [x] работа с ордерами - история, филлмент, события
- [x] тесты и сверка данных: репорт, ордера, трейды и стакан

## 08-12-23

- [x] пофиксить зависания в трейдинге - race conditions
- [x] зарефакторить TradeItem - варианты использования?

- [x] для трейдов сделать линейный список
- [x] доставать репорты по позициям и аканутам
- [ ] агрегация трейдов и формирование маркет даты
- [x] реестр и отображение ордеров
- [x] история событий по ордеру
- [x] действия и события над ордерами - отмена, режект, движение, ресайз, создание

## 06-12-23

- [x] refitClient and Contracts
- [x] console client via refit client - use cases and scenarios

### Tech Debt
- awating - cancel, race conditions

## 04-12-23

### Client Side
- [x] await model for commands (tcs + cancel)
- [x] fix invalid user bug - place order
- [x] fix POST params - place order
- [ ] market data feed (background service)
- [x] orderbooks feed (background service)
- [ ] user reports (user account, user status, orders)
- [ ] market dashboard
- [x] orderbooks dashboard
- [ ] order history
- [ ] symbols CRUD
- [x] admin adds users

#### Client Strategies
- Market Maker
- Random Walk

### Tech Debt
- [x] remove protobuf
- integration tests
- startup/shutdown
- reconnect on disconnect

### Blazor client


## 03-12-23

### Background services
- https://habr.com/ru/articles/658847/
- https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-8.0&tabs=visual-studio
- https://learn.microsoft.com/ru-ru/dotnet/architecture/microservices/multi-container-microservice-net-applications/background-tasks-with-ihostedservice


## 02-12-23

- [x] выпилен GRPC
- [x] выпилен tcs & awating service
- [x] moving to net8.0
- [ ] восстановить тесты по API
- [ ] выпилить proto и заменить DTO контрактами
- [ ] корректный шутдаун хаба - нотификации клиентам
- [ ] типизированный вызов фукнкций из хаба?
 
## 30-11-23

- [x] выпилен Nats
- [x] встроен SignalR
- [x] есть консольный клиент (заготовка)

### Дальше
- разобраться с tcs: cancel и обработка ошибок
- интерактивная консоль + мультитред для обработки стримов
- разобраться с channel и его работой
- перевести API на SignalR и избавиться от gRPC?
 

## 05-10-23
- [x] добавить uid во все евенты
- [x] добавить seq во все евенты
- протестить proto сериализацию для Nats

### Дальше
- консольный клиент
- интеграционные тесты

## 01-10-23
- добавить конфиг для NATS сервера
- разобраться с await в хендлере
- доработать сабжекты
- интеграционные тесты
- [x] рефакторинг структуры солюшенов и шаринга классов

### Next
- клиентская часть


## 29-09-23

- интеграционные тесты
- sequence - прорбасывать везде (commandResult, trades, orderBook)
- разобраться с Timestamp
- базовая публикация в NATS
- докер для NATS сервера
- дорабоать регистрацию в DI  


## 28-09-23

### Дальше

- серверный стрим и генераторы евентов для стримов
- клиентская часть - подписка на стримы?
- клиентская либа
- интеграционные тесты
- UI
- серверная часть в докере


#### клиентская либа?
- декодировать репорт из бинарного массива евента
- подключение к евент стримам
- командный интерфейс на клиентской части

## 27-09-23

## GRPC
- [x] OrderIdGen service
- [x] CurrentTime service
- [x] Full API
- Server Stream
- Integration tests
 
## Next
- Event streams
- UI 
- CLI

## 24-09-23

## GRPC
- [x] шаринг прото-файлов между клиентом и серверм
- серверный стриминг - пример

## Генерация и передача стримов на клиента 
- возможно(нужно) использование Rx?
- возможно(нужно) использование IAsyncEnumerable

## 23-09-23

### Сделано
- слой Application Services

### Следующий этап 
- [x] GRPC host
- [x] GRPC client
 
## 22-09-23

### Доделать
- [x] place order 
- [x] move order 
- [x] reduce order 
- [x] cancel order 

- [x] интеграционные тесты и прогон базовых сценариев (2 трейдера)
- обработчики\провайдеры евентов по результатам отработки команды (EventProvessor)

- [x] тесты для suspend, resume, adjust balance
- [x] API для бинарных команд
- [x] API команды для репортов
- [x] reset

## 18-09-23

### Сделано
- API команды в базовом варианте
- Тест для NOP, подключение API и async Send
- Провайдеры для OrderId и CurrentTime

### Доделать
- [x] логгер для матчинг-енжина
- [x] инстансы енжинов - через DI
- [x] адаптировать тесты для DI
- [-] втащить Accounts в RiskEngine

## 09-09-23

### Доделать
- формирование резалта из API и его обработка
- дописать фэктори для OrderCommand
- тесты на API и сборка стенда
- хендлеры евентов - в виде лога

## 08-09-23

### Закончено в MVP
- Доменная модель
- Exchange Core и обработчики для енжинов
- Awating Service
 
### Дальше
- API и его команды - маппинг в OrderCommand
- Подключить енжины и прогнать тесты по всем командам API
- Возврат значений из Await-а - продумать структуры данных вместо OrderCommand
- Handler для формирования маркет фидов и его подключение к фидам (Aeron?)
- Клиентская либа для API - в каком виде? (REST, GRPC, Aeron)
- Торговые агенты в виде одельных консолей

## 03-09-23

### Пока не сделано (выброшено из скопа)
- Репорт StateHash
- Репорт Total Currency Balance

### Next steps
- Подключить дисраптор
- Интегрировать енжины в дисраптор
- Подключить логирование
- Продумать клиентский API
- Продумать возврать значений для команд (TCS?)
- Продумать возврат евентов (маркет фиды)


## 22-08-23

### Выброшено из MVP
- хранение аджастментов
- комиссии
- торговля валютными парами
- lastPriceCache?
- 

## 21-08-23

- выключить RiskEngine в плане проверок по торговле валютой и маржинальной тороговли (фьючи) - оформить отдельной фичей
- оставить минимальный функционал Risk Engine - для расчета позиций, сделок и аккаунтов
- доработать другие части системы: дисраптор, евенты, репортниг, API
- запустить MVP торговлю
 

## 20-08-23

### Рефакторинг
- accounts & users & positions
- order processing in risk engine
 

## 18-08-23

- логирование
- рефакторинг
- юнит-тесты
- репортинг

## 17-08-23

### RiskEngine Parts

- ReserveBidPrice
- fees.clear();
- adjustments.clear();
- suspends.clear();


## 16-08-23

### Risk Engine - посмотреть в Java коде
- допилить пре-процессинг
- допилить пост-процессинг
- доделать аджастмент-тайпы
- уточнить по CurrentPriceCache

### Дальше
- тесты на риск енжин
- подумать и зарефакторить обработку бинарных команд ?
- логирование и ексепшены?
- репорты
- события и фиды по событиям


## 14-08-23

### Risk Engine Tests
- Binary Commands: Symbols, Accounts
- PlaceOrder
- User Management
- Reset
- PostProcess

## 13-08-23

- поправить тесты
- синкануть типы команд в енжинах и команд процессорах
- обработка эксепшенов?
- рефакторинг риск-енжина


## 12-08-23

- модуль OME готов вмержен в мастер
- дописать и проверить правильность возврата кодов из процессора
- продумать механику обработки ексепшенов
- продумать логирование

### Дальше
- написать риск енжин + тесты
- написать евент фиды на выходе
- соединить ome + riskengine в дисрапторе

## 24-07-23

### Сделать
- пересмотреть архитектуру и зарефакторить OME
- написать юнит тесты и посмотреть как работает OME

### Отложено
- доделать RiskEngine
- разобраться с репортами
- разобраться с выходными фидами и евентами
- разобраться зачем нужны мастер процессоры P1 и P1

## 23-07-23

- Risk Engine - базовая реализация
- Реализовать схему с промисами в API через финальный event handler
- Реализовать репорты
- API 
- фиды с евентами (?)

## 22-07-23

- распилить BinaryCommandsProcessor на два - разнести по папкам

### Что делать с внешними (не Order) командами?

- добавить в команду поле с бинарным буфером
- реализовать примитивы, сериализующиеся в буфер
- десериализация - по типу команды
- вместо бинарного (SBE, Proto) формата пока использовать JSON


### Доработки
- написать тесты для матчинга
- зарефакторить код в домене


## 17-07-23T22:58
- для бакетов использовать [LinkedHashMaap](https://github.com/idlerboris/LinkedHashMap/blob/master/CustomCollections/CustomCollections/LinkedHashMap.cs) 
- для книжек использовать [TreeMap](https://github.com/Giedrius-Kristinaitis/TreeMap/tree/master/C-Sharp%20TreeMap%20Implementation%20and%20Test) 
либо [NavigableMap](https://gist.github.com/R2D221/f0363e0ee7123c4d7693)
- проанализировать построение алгоритмов на этих структурах - КЧД - аналог TreeMap?

ART
- [adaptive-radix-tree](https://github.com/rafaelkallis/adaptive-radix-tree)
- [Adaptive Radix Tree](https://github.com/manly/AdaptiveRadixTree)

## 17-07-23
- схематичное описание архитектуры
- юзер-стори по функционалу
- выделить баундед контексты и доменные модели
- распределить функционал по модулям\папкам
- продумать реализацию MVP на основе портированного кода

## 12-07-23
- перераспределить сущности по папкам
- доделать генерацию всех евентов из OrderCommand
- разбить один евент консьюмер на три
- для всех объектов перенести общие свойства в базовые классы
- ордер матчинг - имплементация

## 10-07-23
- доделать MatcherEvent и обвязку вокруг него
- доделать TradeEvents и обвязку вокруг них
- генерировать маркет дату
- зарефакторить хендлеры дисраптора. Оставить только действительно нужные
- переключиться на матчинг енжин


## 09-07-23
- Disruptor Exception Hhandler
- Async events handler
- Не возвращать OrderCommand в евентах - нужен другой объект
- implement API commands

## 02-07-23

### US-1 Basic Disruptor Engine via REST API
- ASP.NET хост Vertr.Exchange.Server
- простой REST API для поткока входящих ордеров
- простой набор хендлеров для дисраптора
-- order command processor - закидывает в Disruptor
-- order matching - матчит ордера
-- event processor - собирает и создает события
-- event publisher - публикует события в консоль
Дополнительно для тестов
- простая inMemory DB для хранения событий вместе/вместо консоли/лога
- простой REST API для извлечения и просмотра событий из DB

### US-1-A Доработка (разработка) алгоритмов Mathing Engine
- доменная модель и сущности, структуры данных
- простой наивный алгоритм
- типовой алгоритм

### US-2 Замена/дополнение REST Аероном
- ASP.NET хост Vertr.Exchange.Proxy
- Каналы аерона для связи с сервером
- REST/Grpc API для потока ордеров
- DB - хранение информации о клиенте, ордерах и событиях
- REST/GRPC клиенты для запроса информации (ордера, портфель, маркет даата, сделки и тп.)

### Бэклог
- Раутинг и мультиплексирование запросов по книгам (символам)
- Администрирование символов
- Администрирование аккаунта. Депозит. Несколько аккаунтов
- Клиентский портфель и его показатели
 


## 16-06-23
- Неявный пайплайн через ченнел. Неудобно и не видно, что происходит. Нужна более явная логика
- Сложная схема с книгами - нужно упростить и переделать

## 25-05-23
- MessageQueue, MessageQueueProvider
- Notifications(Events) in Domain - IMediator
- Remaining Qty for Orders?

## 24-05-23
- Add MarketData - Best Bid-Ask, LastTrade Ptrice/Qty, Time

## 22-05-23 
- Command Processor (Mediatr)
- Cancel Order Command - (Hashset + Stack)

## 19-05-23 Order matching engine

- не регистрируем сделки Market - Market (тк нужно брать откуда-то цену)
- для маркет ордеров - всегда ходим в лимитную книгу, если там ничего нет - кладем его в маркет книгу
- для лимит ордеров - всегда вначале проверяем маркетную книгу

### Тесты
- тесты для ордербука
- тесты для маркет ордеров
- наполнение ордербуков
- снапшонты ордербука до и после матчинга ордера

### Функционал
- (!) отмена (cancel) ордеров в книге?
- визуальное отображение книг (стакан заявок) - в статике и динамике
- доменная обвязка - хранение ордеров и трейдов
- событийная модель - что использовать? хранение событий?

### Вопросы
- Переопределен ли хэшкод и операции сравнения в структурах? Как проверить?
- Массив и коллекция стуктур размещаются в стеке?
- Можно сделать спан из трейдов и передать его наружу
- Матчи правильно отрабатывают при всех комбинациях ордеров и книжек
- Цена сделки соответствует полиси
- Сервис работает в Zero allcation моде
- Сервис держит нагрузку
- Чем заменить Debug.Assert?



